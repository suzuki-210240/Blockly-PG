from AdminApp.models import Kadai, KadaiProgress
from django.contrib.auth.models import User

def link_existing_data():
    """既存のユーザーと課題を紐づけて進捗データを生成"""
    # すべてのユーザーと課題を取得
    users = User.objects.all()
    kadai_list = Kadai.objects.all()

    # 既存の進捗データを取得（user_id, kadai_id のペア）
    existing_progress = set(
        KadaiProgress.objects.values_list('user_id', 'kadai_id')
    )

    # 新たに生成する進捗データを準備
    new_progress = []
    for user in users:
        for kadai in kadai_list:
            if (user.id, kadai.number) not in existing_progress:
                new_progress.append(
                    KadaiProgress(user=user, kadai=kadai)
                )

    # 進捗データを一括生成
    if new_progress:
        KadaiProgress.objects.bulk_create(new_progress)
        print(f"新たに {len(new_progress)} 件の進捗データを生成しました。")
    else:
        print("生成する進捗データはありません。")

# 実行
link_existing_data()
